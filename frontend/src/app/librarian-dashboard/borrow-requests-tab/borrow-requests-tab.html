<div class="borrow-requests-container">
    <div class="header-section">
        <h2>Borrow Records</h2>
        <button class="refresh-btn" (click)="refreshData()" [disabled]="loading">
            @if (!loading) {
              <span>Refresh</span>
            }
            @if (loading) {
              <span>Loading...</span>
            }
        </button>
    </div>

    @if (successMessage) {
      <div class="alert alert-success">{{ successMessage }}</div>
    }
    @if (errorMessage) {
      <div class="alert alert-error">{{ errorMessage }}</div>
    }

    <div class="stats-cards">
        <div class="stat-card pending">
            <div class="stat-icon">
                <img src="assets/icons/pending.png" alt="Pending" class="stat-img" />
            </div>
            <div class="stat-info">
                <h3>{{ getPendingRequestsCount() }}</h3>
                <p>Pending Requests</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <img src="assets/icons/borrow-book.png" alt="Active Borrows" class="stat-img" />
            </div>
            <div class="stat-info">
                <h3>{{ getActiveBorrowsCount() }}</h3>
                <p>Active Borrows</p>
            </div>
        </div>
        <div class="stat-card overdue">
            <div class="stat-icon">
                <img src="assets/icons/deadline.png" alt="Overdue" class="stat-img" />
            </div>
            <div class="stat-info">
                <h3>{{ getOverdueBorrowsCount() }}</h3>
                <p>Overdue Books</p>
            </div>
        </div>
        <div class="stat-card returned">
            <div class="stat-icon">
                <img src="assets/icons/check.png" alt="Returned" class="stat-img" />
            </div>
            <div class="stat-info">
                <h3>{{ getReturnedBorrowsCount() }}</h3>
                <p>Returned Books</p>
            </div>
        </div>
    </div>

    <div class="filters-section">
        <div class="search-box">
            <input 
                type="text" 
                [(ngModel)]="searchTerm" 
                (input)="onSearch()"
                placeholder="Search by book title, user name, or email..."
                class="search-input"
            />
        </div>
        
        <div class="filter-group">
            <select [(ngModel)]="filterStatus" (change)="onFilterChange()" class="filter-select">
                <option value="all">All Records</option>
                <option value="pending">Pending Requests</option>
                <option value="active">Active Borrows</option>
                <option value="overdue">Overdue</option>
                <option value="returned">Returned</option>
                <option value="rejected">Rejected</option>
            </select>
        </div>
    </div>

    @if (loading) {
      <div class="loading-container">
          <div class="spinner"></div>
          <p>Loading borrow records...</p>
      </div>
    }

    @if (!loading && paginatedBorrows.length > 0) {
      <div class="table-container">
        <table class="borrow-table">
            <thead>
                <tr>
                    <th>Book Title</th>
                    <th>Borrower</th>
                    <th>Borrow Date</th>
                    <th>Due Date</th>
                    <th>Returned Date</th>
                    <th>Status</th>
                    <th>Days</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @for (borrow of paginatedBorrows; track borrow.id) {
                  <tr [class.overdue-row]="borrow.isOverdue">
                    <td class="book-title">{{ borrow.bookTitle }}</td>
                    <td>
                        <div class="user-info">
                            <strong>{{ borrow.userName }}</strong>
                            <small>{{ borrow.userEmail }}</small>
                        </div>
                    </td>
                    <td>{{ formatDate(borrow.borrowDate) }}</td>
                    <td>{{ formatDate(borrow.dueDate) }}</td>
                    <td>
                      @if (borrow.returnDate) {
                        {{ formatDate(borrow.returnDate) }}
                      } @else {
                        -
                      }
                    </td>
                    <td>
                        <span class="status-badge" [ngClass]="getStatusClass(borrow)">
                            {{ getStatusText(borrow) }}
                        </span>
                    </td>
                    <td>
                                                @if (borrow.status !== 'RETURNED') {
                                                    <span>
                                                            @if (!borrow.isOverdue) {
                                                                <span class="days-remaining">
                                                                        {{ calculateDaysRemaining(borrow.dueDate) }} days left
                                                                </span>
                                                            }
                                                            @if (borrow.isOverdue) {
                                                                <span class="days-overdue">
                                                                        {{ calculateDaysRemaining(borrow.dueDate) * -1 }} days overdue
                                                                </span>
                                                            }
                                                    </span>
                                                }
                                                @if (borrow.status === 'RETURNED') {
                                                    <span>-</span>
                                                }
                    </td>
                    <td>
                        <button class="btn-view" (click)="viewDetails(borrow)">
                            View Details
                        </button>
                        @if (borrow.status === 'PENDING') {
                          <button 
                              class="btn-approve" 
                              (click)="approveBorrowRequest(borrow)"
                              [disabled]="processingAction">
                              ✓ Approve
                          </button>
                        }
                        @if (borrow.status === 'PENDING') {
                          <button 
                              class="btn-reject" 
                              (click)="openRejectModal(borrow)"
                              [disabled]="processingAction">
                              ✗ Reject
                          </button>
                        }
                        @if (borrow.status === 'BORROWED' && !borrow.isOverdue) {
                          <button 
                              class="btn-return" 
                              (click)="openReturnModal(borrow)"
                              [disabled]="processingAction">
                              Return
                          </button>
                        }
                        @if (borrow.isOverdue) {
                          <button 
                              class="btn-return overdue" 
                              (click)="openReturnModal(borrow)"
                              [disabled]="processingAction">
                              Return (Overdue)
                          </button>
                        }
                    </td>
                </tr>
                }
            </tbody>
        </table>
      </div>
    }

    @if (!loading && paginatedBorrows.length === 0) {
      <div class="no-records">
          <p>No borrow records found.</p>
          @if (searchTerm || filterStatus !== 'all') {
            <p>Try adjusting your filters.</p>
          }
      </div>
    }

        @if (totalPages > 1) {
            <div class="pagination">
                <button 
                        class="page-btn" 
                        (click)="goToPage(currentPage - 1)" 
                        [disabled]="currentPage === 1">
                        Previous
                </button>
        
                @for (page of getPageNumbers(); track page) {
                    <button 
                            class="page-btn" 
                            [class.active]="page === currentPage"
                            (click)="goToPage(page)">
                            {{ page }}
                    </button>
                }
        
                <button 
                        class="page-btn" 
                        (click)="goToPage(currentPage + 1)" 
                        [disabled]="currentPage === totalPages">
                        Next
                </button>
            </div>
        }

@if (showDetailsModal) {
    <div class="modal-overlay" (click)="closeDetailsModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Borrow Record Details</h3>
            <button class="close-btn" (click)="closeDetailsModal()">×</button>
        </div>
        
        @if (selectedBorrow) {
          <div class="modal-body">
            <div class="detail-section">
                <h4>Book Information</h4>
                <div class="detail-row">
                    <span class="label">Title:</span>
                    <span class="value">{{ selectedBorrow.bookTitle }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Author:</span>
                    <span class="value">{{ selectedBorrow.bookAuthor }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">ISBN:</span>
                    <span class="value">{{ selectedBorrow.bookIsbn }}</span>
                </div>
            </div>

            <div class="detail-section">
                <h4>Borrower Information</h4>
                <div class="detail-row">
                    <span class="label">Name:</span>
                    <span class="value">{{ selectedBorrow.userName }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Email:</span>
                    <span class="value">{{ selectedBorrow.userEmail }}</span>
                </div>
            </div>

            <div class="detail-section">
                <h4>Borrow Details</h4>
                <div class="detail-row">
                    <span class="label">Borrow Date:</span>
                    <span class="value">{{ formatDate(selectedBorrow.borrowDate) }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Due Date:</span>
                    <span class="value">{{ formatDate(selectedBorrow.dueDate) }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Returned Date:</span>
                    <span class="value">
                      @if (selectedBorrow.returnDate) {
                        {{ formatDate(selectedBorrow.returnDate) }}
                      } @else {
                        -
                      }
                    </span>
                </div>
                <div class="detail-row">
                    <span class="label">Status:</span>
                    <span class="value">
                        <span class="status-badge" [ngClass]="getStatusClass(selectedBorrow)">
                            {{ getStatusText(selectedBorrow) }}
                        </span>
                    </span>
                </div>
                @if (selectedBorrow.fineAmount > 0) {
                  <div class="detail-row">
                      <span class="label">Fine Amount:</span>
                      <span class="value fine-amount">${{ selectedBorrow.fineAmount.toFixed(2) }}</span>
                  </div>
                }
                @if (selectedBorrow.status === 'REJECTED' && selectedBorrow.rejectionReason) {
                  <div class="detail-row">
                      <span class="label">Rejection Reason:</span>
                      <span class="value rejection-reason">{{ selectedBorrow.rejectionReason }}</span>
                  </div>
                }
            </div>
          </div>
        }
                </div>
        </div>
    }

@if (showRejectModal) {
  <div class="modal-overlay" (click)="closeRejectModal()">
    <div class="modal-content reject-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Reject Borrow Record</h3>
            <button class="close-btn" (click)="closeRejectModal()">×</button>
        </div>
        
        @if (borrowToReject) {
          <div class="modal-body">
            <p>Are you sure you want to reject the borrow record for:</p>
            <div class="reject-info">
                <strong>Book:</strong> {{ borrowToReject.bookTitle }}<br>
                <strong>User:</strong> {{ borrowToReject.userName }}
            </div>
            
            <div class="form-group">
                <label for="rejectReason">Reason for Rejection (optional):</label>
                <textarea 
                    id="rejectReason"
                    [(ngModel)]="rejectReason" 
                    class="reject-textarea"
                    placeholder="e.g., Book is reserved for another user, User has overdue books..."
                    rows="4">
                </textarea>
            </div>
            
            <div class="modal-actions">
                <button 
                    class="btn-cancel" 
                    (click)="closeRejectModal()"
                    [disabled]="processingAction">
                    Cancel
                </button>
                <button 
                    class="btn-reject-confirm" 
                    (click)="rejectBorrowRequest()"
                    [disabled]="processingAction">
                    @if (!processingAction) {
                      <span>Reject Request</span>
                    }
                    @if (processingAction) {
                      <span>Processing...</span>
                    }
                </button>
            </div>
          </div>
        }
    </div>
  </div>
}

@if (showReturnModal) {
  <div class="modal-overlay" (click)="closeReturnModal()">
    <div class="modal-content return-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Return Book</h3>
            <button class="close-btn" (click)="closeReturnModal()">×</button>
        </div>
        
        @if (borrowToReturn) {
          <div class="modal-body">
            <p>Confirm return of the following book:</p>
            <div class="return-info">
                <div class="detail-row">
                    <span class="label">Book:</span>
                    <span class="value">{{ borrowToReturn.bookTitle }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Author:</span>
                    <span class="value">{{ borrowToReturn.bookAuthor }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Borrower:</span>
                    <span class="value">{{ borrowToReturn.userName }} ({{ borrowToReturn.userEmail }})</span>
                </div>
                <div class="detail-row">
                    <span class="label">Borrow Date:</span>
                    <span class="value">{{ formatDate(borrowToReturn.borrowDate) }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Due Date:</span>
                    <span class="value" [class.overdue-text]="borrowToReturn.isOverdue">
                        {{ formatDate(borrowToReturn.dueDate) }}
                    </span>
                </div>
                @if (borrowToReturn.isOverdue) {
                  <div class="detail-row">
                      <span class="label">Days Overdue:</span>
                      <span class="value overdue-text">
                          {{ calculateDaysRemaining(borrowToReturn.dueDate) * -1 }} days
                      </span>
                  </div>
                }
            </div>
            
            @if (borrowToReturn.isOverdue) {
              <div class="warning-message">
                  <strong>Note:</strong> This book is overdue. A fine may apply.
              </div>
            }
            
            <div class="modal-actions">
                <button 
                    class="btn-cancel" 
                    (click)="closeReturnModal()"
                    [disabled]="processingAction">
                    Cancel
                </button>
                <button 
                    class="btn-return-confirm" 
                    (click)="confirmReturnBook()"
                    [disabled]="processingAction">
                    @if (!processingAction) {
                      <span>Confirm Return</span>
                    }
                    @if (processingAction) {
                      <span>Processing...</span>
                    }
                </button>
            </div>
          </div>
        }
    </div>
  </div>
}
