<div class="borrow-requests-container">
    <div class="header-section">
        <h2>Borrow Records</h2>
        <button class="refresh-btn" (click)="refreshData()" [disabled]="loading">
            <span *ngIf="!loading">Refresh</span>
            <span *ngIf="loading">Loading...</span>
        </button>
    </div>

    <div class="alert alert-success" *ngIf="successMessage">{{ successMessage }}</div>
    <div class="alert alert-error" *ngIf="errorMessage">{{ errorMessage }}</div>

    <div class="stats-cards">
        <div class="stat-card pending">
            <div class="stat-icon">
                <img src="assets/icons/pending.png" alt="Pending" class="stat-img" />
            </div>
            <div class="stat-info">
                <h3>{{ getPendingRequestsCount() }}</h3>
                <p>Pending Requests</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <img src="assets/icons/borrow-book.png" alt="Active Borrows" class="stat-img" />
            </div>
            <div class="stat-info">
                <h3>{{ getActiveBorrowsCount() }}</h3>
                <p>Active Borrows</p>
            </div>
        </div>
        <div class="stat-card overdue">
            <div class="stat-icon">
                <img src="assets/icons/deadline.png" alt="Overdue" class="stat-img" />
            </div>
            <div class="stat-info">
                <h3>{{ getOverdueBorrowsCount() }}</h3>
                <p>Overdue Books</p>
            </div>
        </div>
        <div class="stat-card returned">
            <div class="stat-icon">
                <img src="assets/icons/check.png" alt="Returned" class="stat-img" />
            </div>
            <div class="stat-info">
                <h3>{{ getReturnedBorrowsCount() }}</h3>
                <p>Returned Books</p>
            </div>
        </div>
    </div>

    <div class="filters-section">
        <div class="search-box">
            <input 
                type="text" 
                [(ngModel)]="searchTerm" 
                (input)="onSearch()"
                placeholder="Search by book title, user name, or email..."
                class="search-input"
            />
        </div>
        
        <div class="filter-group">
            <select [(ngModel)]="filterStatus" (change)="onFilterChange()" class="filter-select">
                <option value="all">All Records</option>
                <option value="pending">Pending Requests</option>
                <option value="active">Active Borrows</option>
                <option value="overdue">Overdue</option>
                <option value="returned">Returned</option>
                <option value="rejected">Rejected</option>
            </select>
        </div>
    </div>

    <div class="loading-container" *ngIf="loading">
        <div class="spinner"></div>
        <p>Loading borrow records...</p>
    </div>

    <div class="table-container" *ngIf="!loading && paginatedBorrows.length > 0">
        <table class="borrow-table">
            <thead>
                <tr>
                    <th>Book Title</th>
                    <th>Borrower</th>
                    <th>Borrow Date</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Days</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let borrow of paginatedBorrows" [class.overdue-row]="borrow.isOverdue">
                    <td class="book-title">{{ borrow.bookTitle }}</td>
                    <td>
                        <div class="user-info">
                            <strong>{{ borrow.userName }}</strong>
                            <small>{{ borrow.userEmail }}</small>
                        </div>
                    </td>
                    <td>{{ formatDate(borrow.borrowDate) }}</td>
                    <td>{{ formatDate(borrow.dueDate) }}</td>
                    <td>
                        <span class="status-badge" [ngClass]="getStatusClass(borrow)">
                            {{ getStatusText(borrow) }}
                        </span>
                    </td>
                    <td>
                        <span *ngIf="borrow.status !== 'RETURNED'">
                            <span *ngIf="!borrow.isOverdue" class="days-remaining">
                                {{ calculateDaysRemaining(borrow.dueDate) }} days left
                            </span>
                            <span *ngIf="borrow.isOverdue" class="days-overdue">
                                {{ calculateDaysRemaining(borrow.dueDate) * -1 }} days overdue
                            </span>
                        </span>
                        <span *ngIf="borrow.status === 'RETURNED'">-</span>
                    </td>
                    <td>
                        <button class="btn-view" (click)="viewDetails(borrow)">
                            View Details
                        </button>
                        <button 
                            *ngIf="borrow.status === 'PENDING'" 
                            class="btn-approve" 
                            (click)="approveBorrowRequest(borrow)"
                            [disabled]="processingAction">
                            ✓ Approve
                        </button>
                        <button 
                            *ngIf="borrow.status === 'PENDING'" 
                            class="btn-reject" 
                            (click)="openRejectModal(borrow)"
                            [disabled]="processingAction">
                            ✗ Reject
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="no-records" *ngIf="!loading && paginatedBorrows.length === 0">
        <p>No borrow records found.</p>
        <p *ngIf="searchTerm || filterStatus !== 'all'">Try adjusting your filters.</p>
    </div>

    <div class="pagination" *ngIf="totalPages > 1">
        <button 
            class="page-btn" 
            (click)="goToPage(currentPage - 1)" 
            [disabled]="currentPage === 1">
            Previous
        </button>
        
        <button 
            *ngFor="let page of getPageNumbers()" 
            class="page-btn" 
            [class.active]="page === currentPage"
            (click)="goToPage(page)">
            {{ page }}
        </button>
        
        <button 
            class="page-btn" 
            (click)="goToPage(currentPage + 1)" 
            [disabled]="currentPage === totalPages">
            Next
        </button>
    </div>
</div>

<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Borrow Record Details</h3>
            <button class="close-btn" (click)="closeDetailsModal()">×</button>
        </div>
        
        <div class="modal-body" *ngIf="selectedBorrow">
            <div class="detail-section">
                <h4>Book Information</h4>
                <div class="detail-row">
                    <span class="label">Title:</span>
                    <span class="value">{{ selectedBorrow.bookTitle }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Author:</span>
                    <span class="value">{{ selectedBorrow.bookAuthor }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">ISBN:</span>
                    <span class="value">{{ selectedBorrow.bookIsbn }}</span>
                </div>
            </div>

            <div class="detail-section">
                <h4>Borrower Information</h4>
                <div class="detail-row">
                    <span class="label">Name:</span>
                    <span class="value">{{ selectedBorrow.userName }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Email:</span>
                    <span class="value">{{ selectedBorrow.userEmail }}</span>
                </div>
            </div>

            <div class="detail-section">
                <h4>Borrow Details</h4>
                <div class="detail-row">
                    <span class="label">Borrow Date:</span>
                    <span class="value">{{ formatDate(selectedBorrow.borrowDate) }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Due Date:</span>
                    <span class="value">{{ formatDate(selectedBorrow.dueDate) }}</span>
                </div>
                <div class="detail-row">
                    <span class="label">Status:</span>
                    <span class="value">
                        <span class="status-badge" [ngClass]="getStatusClass(selectedBorrow)">
                            {{ getStatusText(selectedBorrow) }}
                        </span>
                    </span>
                </div>
                <div class="detail-row" *ngIf="selectedBorrow.fineAmount > 0">
                    <span class="label">Fine Amount:</span>
                    <span class="value fine-amount">${{ selectedBorrow.fineAmount.toFixed(2) }}</span>
                </div>
                <div class="detail-row" *ngIf="selectedBorrow.status === 'REJECTED' && selectedBorrow.rejectionReason">
                    <span class="label">Rejection Reason:</span>
                    <span class="value rejection-reason">{{ selectedBorrow.rejectionReason }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" *ngIf="showRejectModal" (click)="closeRejectModal()">
    <div class="modal-content reject-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>Reject Borrow Record</h3>
            <button class="close-btn" (click)="closeRejectModal()">×</button>
        </div>
        
        <div class="modal-body" *ngIf="borrowToReject">
            <p>Are you sure you want to reject the borrow record for:</p>
            <div class="reject-info">
                <strong>Book:</strong> {{ borrowToReject.bookTitle }}<br>
                <strong>User:</strong> {{ borrowToReject.userName }}
            </div>
            
            <div class="form-group">
                <label for="rejectReason">Reason for Rejection (optional):</label>
                <textarea 
                    id="rejectReason"
                    [(ngModel)]="rejectReason" 
                    class="reject-textarea"
                    placeholder="e.g., Book is reserved for another user, User has overdue books..."
                    rows="4">
                </textarea>
            </div>
            
            <div class="modal-actions">
                <button 
                    class="btn-cancel" 
                    (click)="closeRejectModal()"
                    [disabled]="processingAction">
                    Cancel
                </button>
                <button 
                    class="btn-reject-confirm" 
                    (click)="rejectBorrowRequest()"
                    [disabled]="processingAction">
                    <span *ngIf="!processingAction">Reject Request</span>
                    <span *ngIf="processingAction">Processing...</span>
                </button>
            </div>
        </div>
    </div>
</div>
