<div class="my-books-container">
  <div class="header">
    <h1>My Books</h1>
    <p class="subtitle">View your borrowed books and return history</p>
  </div>

  <!-- Filter Tabs -->
  <div class="filter-tabs">
    <button class="filter-tab" 
            [class.active]="activeFilter === 'all'"
            (click)="setFilter('all')">
      All ({{ allBorrows.length }})
    </button>
    <button class="filter-tab" 
            [class.active]="activeFilter === 'borrowed'"
            (click)="setFilter('borrowed')">
      Borrowed ({{ getActiveCount() }})
    </button>
    <button class="filter-tab" 
            [class.active]="activeFilter === 'pending'"
            (click)="setFilter('pending')">
      Pending ({{ getPendingCount() }})
    </button>
    <button class="filter-tab" 
            [class.active]="activeFilter === 'overdue'"
            (click)="setFilter('overdue')">
      Overdue ({{ getOverdueCount() }})
    </button>
    <button class="filter-tab" 
            [class.active]="activeFilter === 'returned'"
            (click)="setFilter('returned')">
      Returned ({{ getReturnedCount() }})
    </button>
  </div>

  <!-- Search Bar -->
  <div class="search-bar">
    <input type="text" 
           [(ngModel)]="searchTerm" 
           (input)="onSearch()"
           placeholder="Search by book title or author..." 
           class="search-input" />
  </div>

  @if (loading) {
    <div class="loading-message">
      <div class="spinner"></div>
      <p>Loading your books...</p>
    </div>
  }

  @if (errorMessage) {
    <div class="error-message">
      <p>{{ errorMessage }}</p>
      <button (click)="loadMyBooks()" class="retry-btn">Retry</button>
    </div>
  }

  @if (!loading && !errorMessage && filteredBorrows.length === 0) {
    <div class="no-books-message">
      <img src="assets/icons/books.png" alt="No books" class="empty-icon">
      <h3>No books found</h3>
      @if (searchTerm) {
        <p>Try adjusting your search or filters.</p>
      }
      @if (!searchTerm && activeFilter === 'all') {
        <p>You haven't borrowed any books yet.</p>
      }
      @if (!searchTerm && activeFilter !== 'all') {
        <p>No books match this filter.</p>
      }
    </div>
  }

  @if (!loading && !errorMessage && filteredBorrows.length > 0) {
    <div class="books-list">
      @for (borrow of filteredBorrows; track borrow.id) {
        <div class="borrow-card">
      <div class="book-image">
        <img [src]="borrow.bookCoverImage || 'assets/icons/books.png'" 
             [alt]="borrow.bookTitle"
             (error)="$any($event.target).src='assets/icons/books.png'">
      </div>

      <div class="borrow-info">
        <h3 class="book-title">{{ borrow.bookTitle }}</h3>
        <p class="book-author">by {{ borrow.bookAuthor }}</p>
        
        <div class="borrow-details">
          <div class="detail-item">
            <span class="label">Borrowed:</span>
            <span class="value">{{ formatDate(borrow.borrowDate) }}</span>
          </div>
          @if (borrow.dueDate) {
            <div class="detail-item">
              <span class="label">Due:</span>
              <span class="value" [class.overdue]="isOverdue(borrow)">
                {{ formatDate(borrow.dueDate) }}
              </span>
            </div>
          }
          @if (borrow.returnDate) {
            <div class="detail-item">
              <span class="label">Returned:</span>
              <span class="value">{{ formatDate(borrow.returnDate) }}</span>
            </div>
          }
        </div>

        <div class="borrow-status" [ngClass]="getStatusClass(borrow)">
          <span class="status-badge">{{ getStatusText(borrow) }}</span>
          @if (borrow.status === 'REJECTED' && borrow.rejectionReason) {
            <div class="rejection-inline" style="margin-top:0.3rem;">
              <span class="label">Rejection Reason:</span>
              <span class="value rejection-reason">{{ borrow.rejectionReason }}</span>
            </div>
          }
          @if (canReturn(borrow) && !isOverdue(borrow)) {
            <span class="days-info">
              {{ getDaysUntilDue(borrow) }} days remaining
            </span>
          }
          @if (isOverdue(borrow)) {
            <span class="days-info overdue-text">
              {{ -getDaysUntilDue(borrow) }} days overdue
            </span>
          }
        </div>
      </div>

      <div class="borrow-actions">
        @if (canReturn(borrow)) {
          <button class="return-btn" 
                  (click)="openReturnModal(borrow)">
            Return Book
          </button>
        }
      </div>
    </div>
      }
    </div>
  }
</div>

@if (showReturnModal) {
  <div class="modal-overlay" (click)="closeReturnModal()">
  <div class="modal-content return-modal" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeReturnModal()">&times;</button>
    
    <div class="modal-header">
      <h2>Return Book</h2>
    </div>

    @if (selectedBorrow) {
      <div class="modal-body">
      <div class="return-book-info">
        <img [src]="selectedBorrow.bookCoverImage || 'assets/icons/books.png'" 
             [alt]="selectedBorrow.bookTitle"
             class="book-thumbnail"
             (error)="$any($event.target).src='assets/icons/books.png'">
        <div>
          <h3>{{ selectedBorrow.bookTitle }}</h3>
          <p>by {{ selectedBorrow.bookAuthor }}</p>
          <p class="borrowed-date">Borrowed on: {{ formatDate(selectedBorrow.borrowDate) }}</p>
        </div>
      </div>

      <div class="confirmation-message">
        <p>Are you sure you want to return this book?</p>
        <p class="note">This action cannot be undone.</p>
      </div>

      @if (returnSuccess) {
        <div class="success-message">
          <p>{{ returnSuccess }}</p>
        </div>
      }

      @if (returnError) {
        <div class="error-message">
          <p>{{ returnError }}</p>
        </div>
      }

      <div class="modal-actions">
        <button class="cancel-btn" 
                (click)="closeReturnModal()"
                [disabled]="returning">
          Cancel
        </button>
        <button class="confirm-btn" 
                (click)="confirmReturn()"
                [disabled]="returning">
          @if (!returning) {
            <span>Confirm Return</span>
          }
          @if (returning) {
            <span>Returning...</span>
          }
        </button>
      </div>
    </div>
    }
  </div>
  </div>
}
